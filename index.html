import React, { useState, useEffect } from 'react';
import { Plus, Edit2, Trash2, GripVertical, Filter, Check, Clock, Circle } from 'lucide-react';

const PlanHebdoCalendar = () => {
  const [tasks, setTasks] = useState([]);
  const [showAddModal, setShowAddModal] = useState(false);
  const [editingTask, setEditingTask] = useState(null);
  const [filterCategory, setFilterCategory] = useState('Tous');
  const [draggedTask, setDraggedTask] = useState(null);
  const [isLoading, setIsLoading] = useState(true);

  const [formData, setFormData] = useState({
    name: '',
    day: 0,
    slot: 'matin',
    status: 'pending',
    category: 'Religion',
    time: '08:00',
  });

  const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
  const slots = ['matin', 'journee', 'soir'];
  const slotLabels = { matin: 'üåÖ Matin', journee: '‚òÄÔ∏è Journ√©e', soir: 'üåô Soir' };
  const categories = ['Religion', 'Travail', 'Habitude', 'Projet'];

  const categoryColors = {
    Religion: 'border-purple-300 text-purple-900',
    Travail: 'border-blue-300 text-blue-900',
    Habitude: 'border-green-300 text-green-900',
    Projet: 'border-orange-300 text-orange-900',
  };

  const cardBackground = {
    pending: 'bg-gray-50 hover:bg-gray-100',
    inprogress: 'bg-yellow-50 hover:bg-yellow-100',
    done: 'bg-green-50 hover:bg-green-200'
  };

  useEffect(() => {
    loadTasks();
  }, []);

  const loadTasks = async () => {
    try {
      const result = await window.storage?.get?.('hebdo-tasks');
      if (result && result.value) {
        setTasks(JSON.parse(result.value));
      } else {
        const initialTasks = [
          { id: 1, name: 'M√©morisation Coran', day: 0, slot: 'matin', status: 'done', category: 'Religion', time: '07:00' },
          { id: 2, name: 'R√©vision sourates', day: 0, slot: 'matin', status: 'pending', category: 'Religion', time: '08:00' },
          { id: 3, name: 'E-commerce', day: 0, slot: 'journee', status: 'inprogress', category: 'Travail', time: '10:00' },
          { id: 4, name: 'Duolingo', day: 0, slot: 'soir', status: 'done', category: 'Habitude', time: '19:00' },
        ];
        setTasks(initialTasks);
        await saveTasks(initialTasks);
      }
    } catch (error) {
      console.error('Erreur de chargement:', error);
      setTasks([]);
    }
    setIsLoading(false);
  };

  const saveTasks = async (tasksToSave) => {
    try {
      await window.storage?.set?.('hebdo-tasks', JSON.stringify(tasksToSave));
    } catch (error) {
      console.error('Erreur de sauvegarde:', error);
    }
  };

  const getFilteredTasks = () => {
    if (filterCategory === 'Tous') return tasks;
    return tasks.filter(task => task.category === filterCategory);
  };

  const toggleStatus = (taskId, e) => {
    e.stopPropagation();
    const newTasks = tasks.map(task => {
      if (task.id === taskId) {
        const statuses = ['pending', 'inprogress', 'done'];
        const nextStatus = statuses[(statuses.indexOf(task.status) + 1) % statuses.length];
        return { ...task, status: nextStatus };
      }
      return task;
    });
    setTasks(newTasks);
    saveTasks(newTasks);
  };

  const deleteTask = (taskId, e) => {
    e.stopPropagation();
    const newTasks = tasks.filter(task => task.id !== taskId);
    setTasks(newTasks);
    saveTasks(newTasks);
  };

  const addTask = () => {
    if (formData.name.trim()) {
      const newTasks = [...tasks, { ...formData, id: Date.now() }];
      setTasks(newTasks);
      saveTasks(newTasks);
      setShowAddModal(false);
      setFormData({
        name: '',
        day: 0,
        slot: 'matin',
        status: 'pending',
        category: 'Religion',
        time: '08:00',
      });
    }
  };

  const updateTask = () => {
    if (formData.name.trim()) {
      const newTasks = tasks.map(task => task.id === formData.id ? formData : task);
      setTasks(newTasks);
      saveTasks(newTasks);
      setEditingTask(null);
      setFormData({
        name: '',
        day: 0,
        slot: 'matin',
        status: 'pending',
        category: 'Religion',
        time: '08:00',
      });
    }
  };

  const openEditModal = (task, e) => {
    e.stopPropagation();
    setFormData(task);
    setEditingTask(task);
  };

  const openAddModal = () => {
    setFormData({
      name: '',
      day: 0,
      slot: 'matin',
      status: 'pending',
      category: 'Religion',
      time: '08:00',
    });
    setShowAddModal(true);
  };

  const handleDragStart = (e, task) => {
    setDraggedTask(task);
    e.dataTransfer.effectAllowed = 'move';
  };

  const handleDragOver = (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  };

  const handleDrop = (e, dayIndex, slot) => {
    e.preventDefault();
    if (draggedTask) {
      const newTasks = tasks.map(task => task.id === draggedTask.id ? { ...task, day: dayIndex, slot } : task);
      setTasks(newTasks);
      saveTasks(newTasks);
      setDraggedTask(null);
    }
  };

  const StatusIcon = ({ status, onClick }) => {
    const icons = {
      pending: <Circle className="w-5 h-5 text-gray-400" />,
      inprogress: <Clock className="w-5 h-5 text-yellow-600" />,
      done: <Check className="w-5 h-5 text-green-600" />
    };
    return <button onClick={onClick} className="p-1 rounded-full">{icons[status]}</button>;
  };

  const TaskCard = ({ task }) => {
    const bgClass = cardBackground[task.status];
    return (
      <div
        draggable
        onDragStart={(e) => handleDragStart(e, task)}
        className={`p-3 mb-2 rounded-lg border-2 cursor-move transition-all ${categoryColors[task.category]} ${bgClass}`}
        style={{ borderColor: '#C9A58C' }}
      >
        <div className="flex items-start justify-between gap-2">
          <div className="flex items-start gap-2 flex-1">
            <GripVertical className="w-4 h-4 mt-1 opacity-40" style={{ color: '#8B5A45' }} />
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 mb-1">
                <StatusIcon status={task.status} onClick={(e) => toggleStatus(task.id, e)} />
                <span className="font-semibold text-sm truncate" style={{ color: '#6B4532' }}>{task.name}</span>
              </div>
              <div className="text-xs font-medium" style={{ color: '#8B5A45' }}>üïê {task.time}</div>
            </div>
          </div>
          <div className="flex gap-1 flex-shrink-0">
            <button onClick={(e) => openEditModal(task, e)} className="p-1.5 rounded transition-colors hover:bg-white" style={{ color: '#8B5A45' }}>
              <Edit2 className="w-3.5 h-3.5" />
            </button>
            <button onClick={(e) => deleteTask(task.id, e)} className="p-1.5 rounded transition-colors hover:bg-red-100">
              <Trash2 className="w-3.5 h-3.5 text-red-600" />
            </button>
          </div>
        </div>
      </div>
    );
  };

  const TaskFormModal = ({ isEdit }) => (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl" style={{ borderTop: '4px solid #C9A58C' }}>
        <h3 className="text-xl font-bold mb-4" style={{ color: '#6B4532' }}>
          {isEdit ? '‚úèÔ∏è Modifier la t√¢che' : '‚ûï Ajouter une t√¢che'}
        </h3>
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-semibold mb-1" style={{ color: '#8B5A45' }}>Nom de la t√¢che *</label>
            <input
              type="text"
              value={formData.name}
              onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              className="w-full px-3 py-2 border-2 rounded-lg focus:outline-none"
              style={{ borderColor: '#C9A58C', backgroundColor: '#FFF8F3' }}
              placeholder="Ex: M√©morisation Coran"
            />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-semibold mb-1" style={{ color: '#8B5A45' }}>Jour</label>
              <select
                value={formData.day}
                onChange={(e) => setFormData({ ...formData, day: parseInt(e.target.value) })}
                className="w-full px-3 py-2 border-2 rounded-lg focus:outline-none"
                style={{ borderColor: '#C9A58C', backgroundColor: '#FFF8F3' }}
              >
                {days.map((day, i) => <option key={i} value={i}>{day}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-semibold mb-1" style={{ color: '#8B5A45' }}>Cr√©neau</label>
              <select
                value={formData.slot}
                onChange={(e) => setFormData({ ...formData, slot: e.target.value })}
                className="w-full px-3 py-2 border-2 rounded-lg focus:outline-none"
                style={{ borderColor: '#C9A58C', backgroundColor: '#FFF8F3' }}
              >
                {slots.map(slot => <option key={slot} value={slot}>{slotLabels[slot]}</option>)}
              </select>
            </div>
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-semibold mb-1" style={{ color: '#8B5A45' }}>Cat√©gorie</label>
              <select
                value={formData.category}
                onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                className="w-full px-3 py-2 border-2 rounded-lg focus:outline-none"
                style={{ borderColor: '#C9A58C', backgroundColor: '#FFF8F3' }}
              >
                {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-semibold mb-1" style={{ color: '#8B5A45' }}>Heure</label>
              <input
                type="time"
                value={formData.time}
                onChange={(e) => setFormData({ ...formData, time: e.target.value })}
                className="w-full px-3 py-2 border-2 rounded-lg focus:outline-none"
                style={{ borderColor: '#C9A58C', backgroundColor: '#FFF8F3' }}
              />
            </div>
          </div>
          <div className="flex gap-2 pt-4">
            <button
              onClick={isEdit ? updateTask : addTask}
              className="flex-1 text-white py-2.5 rounded-lg font-semibold transition-all hover:opacity-90"
              style={{ background: 'linear-gradient(135deg, #C9A58C 0%, #B8967E 100%)' }}
            >
              {isEdit ? '‚úì Modifier' : '‚úì Ajouter'}
            </button>
            <button
              onClick={() => { isEdit ? setEditingTask(null) : setShowAddModal(false); }}
              className="flex-1 py-2.5 rounded-lg font-semibold transition-all"
              style={{ border: '2px solid #C9A58C', color: '#8B5A45', background: 'white' }}
            >
              Annuler
            </button>
          </div>
        </div>
      </div>
    </div>
  );

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center" style={{ background: '#FFF8F3' }}>
        <div className="text-center">
          <div className="text-2xl font-bold" style={{ color: '#8B5A45' }}>Chargement...</div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen p-6" style={{ background: '#FFF8F3' }}>
      <div className="max-w-7xl mx-auto">
        <div className="rounded-2xl shadow-lg p-6 mb-6" style={{ background: 'linear-gradient(135deg, #E8C4A0 0%, #D9B38C 100%)' }}>
          <h1 className="text-3xl font-bold text-center mb-2" style={{ color: '#6B4532' }}>üéØ Mon Tracker Avanc√©</h1>
          <p className="text-center font-medium" style={{ color: '#8B5A45' }}>Habitudes ‚Ä¢ T√¢ches ‚Ä¢ Objectifs ‚Ä¢ Suivi complet</p>
        </div>

        {/* Filtre et bouton ajouter */}
        <div className="bg-white rounded-xl shadow-lg p-6 mb-4" style={{ boxShadow: '0 2px 8px rgba(139, 90, 69, 0.1)' }}>
          <div className="flex flex-wrap gap-3 items-center justify-between">
            <div className="flex gap-2 items-center flex-wrap">
              <Filter className="w-5 h-5" style={{ color: '#8B5A45' }} />
              <span className="font-semibold" style={{ color: '#6B4532' }}>Filtrer:</span>
              <div className="flex gap-2 flex-wrap">
                <button
                  onClick={() => setFilterCategory('Tous')}
                  className={`px-4 py-2 rounded-lg font-medium transition-all ${filterCategory === 'Tous' ? 'text-white' : ''}`}
                  style={filterCategory === 'Tous' ? { background: 'linear-gradient(135deg, #C9A58C 0%, #B8967E 100%)' } : { border: '2px solid #C9A58C', background: 'white', color: '#8B5A45' }}
                >
                  Tous
                </button>
                {categories.map(cat => (
                  <button
                    key={cat}
                    onClick={() => setFilterCategory(cat)}
                    className={`px-4 py-2 rounded-lg font-medium transition-all ${filterCategory === cat ? 'text-white' : ''}`}
                    style={filterCategory === cat ? { background: 'linear-gradient(135deg, #C9A58C 0%, #B8967E 100%)' } : { border: '2px solid #C9A58C', background: 'white', color: '#8B5A45' }}
                  >
                    {cat}
                  </button>
                ))}
              </div>
            </div>
            <button
              onClick={openAddModal}
              className="flex items-center gap-2 text-white px-6 py-2.5 rounded-lg font-semibold shadow-md transition-all hover:opacity-90"
              style={{ background: 'linear-gradient(135deg, #C9A58C 0%, #B8967E 100%)' }}
            >
              <Plus className="w-5 h-5" /> Ajouter
            </button>
          </div>
        </div>

        {/* Tableau calendrier */}
        <div className="bg-white rounded-xl shadow-lg overflow-hidden" style={{ boxShadow: '0 2px 8px rgba(139, 90, 69, 0.1)' }}>
          <div className="overflow-x-auto">
            <div className="min-w-max">
              <div className="grid grid-cols-8 border-b-2" style={{ borderColor: '#C9A58C' }}>
                <div className="p-4 font-bold border-r" style={{ background: '#FFF8F3', color: '#6B4532', borderColor: '#C9A58C' }}>Cr√©neaux</div>
                {days.map((day, i) => (
                  <div key={i} className="p-4 font-bold text-center border-r" style={{ background: 'linear-gradient(135deg, #E8C4A0 0%, #D9B38C 100%)', color: '#6B4532', borderColor: '#C9A58C' }}>{day}</div>
                ))}
              </div>

              {slots.map(slot => (
                <div key={slot} className="grid grid-cols-8 border-b-2" style={{ borderColor: '#C9A58C' }}>
                  <div className="p-2 font-semibold border-r text-center" style={{ background: '#FFF8F3', color: '#8B5A45', borderColor: '#C9A58C' }}>{slotLabels[slot]}</div>
                  {days.map((day, dayIndex) => (
                    <div
                      key={dayIndex}
                      className="p-2 border-r min-h-[80px] flex flex-col"
                      style={{ borderColor: '#C9A58C' }}
                      onDragOver={handleDragOver}
                      onDrop={(e) => handleDrop(e, dayIndex, slot)}
                    >
                      {getFilteredTasks()
                        .filter(task => task.day === dayIndex && task.slot === slot)
                        .map(task => <TaskCard key={task.id} task={task} />)}
                    </div>
                  ))}
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>

      {showAddModal && <TaskFormModal isEdit={false} />}
      {editingTask && <TaskFormModal isEdit={true} />}
    </div>
  );
};

export default PlanHebdoCalendar;
